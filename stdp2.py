# -*- coding: utf-8 -*-
"""
Created on Sun Aug 11 13:52:03 2019
@author: user
"""
# ==============================================================
# ã‚ªãƒ³ãƒ©ã‚¤ãƒ³STDPï¼ˆSpike-Timing Dependent Plasticityï¼‰ã®é€æ¬¡æ›´æ–°ãƒ¢ãƒ‡ãƒ«
# --------------------------------------------------------------
# æœ¬ã‚³ãƒ¼ãƒ‰ã§ã¯ã€ã‚¹ãƒ‘ã‚¤ã‚¯ã®ç™ºç”Ÿã‚¿ã‚¤ãƒŸãƒ³ã‚°å·®ã«åŸºã¥ãã‚·ãƒŠãƒ—ã‚¹å¯å¡‘æ€§ã‚’
# ã€Œé€æ¬¡æ›´æ–°ï¼ˆonlineï¼‰ã€ã§è¨ˆç®—ã™ã‚‹ã€‚
# STDPã¯ã€ã‚¹ãƒ‘ã‚¤ã‚¯é †åºã«ã‚ˆã£ã¦ã‚·ãƒŠãƒ—ã‚¹å¼·åº¦ï¼ˆé‡ã¿ï¼‰ãŒå¤‰åŒ–ã™ã‚‹å­¦ç¿’å‰‡ã§ã‚ã‚Šã€
# pre â†’ post ã®é †ã§ã‚¹ãƒ‘ã‚¤ã‚¯ãŒç™ºç«ã—ãŸå ´åˆã¯ã‚·ãƒŠãƒ—ã‚¹ãŒå¼·åŒ–ã•ã‚Œï¼ˆLTPï¼‰ã€
# post â†’ pre ã®é †ã§ç™ºç«ã—ãŸå ´åˆã¯ã‚·ãƒŠãƒ—ã‚¹ãŒå¼±åŒ–ã•ã‚Œã‚‹ï¼ˆLTDï¼‰ã€‚
# ==============================================================

import numpy as np
import matplotlib.pyplot as plt

# ä¹±æ•°ã‚·ãƒ¼ãƒ‰ï¼ˆå†ç¾æ€§ã®ç¢ºä¿ï¼‰
np.random.seed(seed=0)

# ==============================================================
# ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®šæ•°ã®è¨­å®š
# --------------------------------------------------------------
# dt : æ™‚é–“åˆ»ã¿å¹… [s]
# T  : ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ [s]
# nt : ã‚¹ãƒ†ãƒƒãƒ—æ•°
# tau_p, tau_m : LTP/LTD ã®æ™‚å®šæ•° [s]
# A_p, A_m : ã‚·ãƒŠãƒ—ã‚¹å¯å¡‘æ€§ã®å­¦ç¿’ä¿‚æ•°
# ==============================================================
dt = 1e-3  # secï¼ˆ=1 msï¼‰
T = 0.5  # secï¼ˆ=500 msï¼‰
nt = round(T / dt)

tau_p = tau_m = 2e-2  # 20 ms
A_p = 0.01  # LTPã®ä¿‚æ•°
A_m = 1.05 * A_p  # LTDã®ä¿‚æ•°ï¼ˆLTPã‚ˆã‚Šã‚ãšã‹ã«å¤§ãã„ï¼‰

# ==============================================================
# ã‚¹ãƒ‘ã‚¤ã‚¯ç³»åˆ—ã®è¨­å®š
# --------------------------------------------------------------
# spike_pre : ã‚·ãƒŠãƒ—ã‚¹å‰ãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ã®ã‚¹ãƒ‘ã‚¤ã‚¯ç³»åˆ—
# spike_post: ã‚·ãƒŠãƒ—ã‚¹å¾Œãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ã®ã‚¹ãƒ‘ã‚¤ã‚¯ç³»åˆ—
# ï¼ˆå›ºå®šçš„ãªã‚¹ãƒ‘ã‚¤ã‚¯ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ç”¨ã„ã¦å­¦ç¿’æŒ™å‹•ã‚’è¦³å¯Ÿï¼‰
# ==============================================================
spike_pre = np.zeros(nt)
spike_pre[[50, 200, 225, 300, 425]] = 1  # preãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ã®ç™ºç«æ™‚åˆ» [mså˜ä½]

spike_post = np.zeros(nt)
spike_post[[100, 150, 250, 350, 400]] = 1  # postãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ã®ç™ºç«æ™‚åˆ»

# ==============================================================
# è¨˜éŒ²ç”¨é…åˆ—ã®åˆæœŸåŒ–
# --------------------------------------------------------------
# x_pre_arr, x_post_arr : pre/postãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ã®ã‚¹ãƒ‘ã‚¤ã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã®å±¥æ­´
# w_arr : ã‚·ãƒŠãƒ—ã‚¹é‡ã¿ã®å¤‰åŒ–å±¥æ­´
# ==============================================================
x_pre_arr = np.zeros(nt)
x_post_arr = np.zeros(nt)
w_arr = np.zeros(nt)

# ==============================================================
# çŠ¶æ…‹å¤‰æ•°ã®åˆæœŸåŒ–
# --------------------------------------------------------------
# x_pre, x_post : pre/postãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ã®ãƒˆãƒ¬ãƒ¼ã‚¹å¤‰æ•°
# w : ã‚·ãƒŠãƒ—ã‚¹é‡ã¿
# ==============================================================
x_pre = 0.0
x_post = 0.0
w = 0.0

# ==============================================================
# ã‚ªãƒ³ãƒ©ã‚¤ãƒ³STDPå­¦ç¿’ãƒ«ãƒ¼ãƒ—
# --------------------------------------------------------------
# å„æ™‚åˆ» t ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œï¼š
#   1. pre/postã‚¹ãƒ‘ã‚¤ã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã®æ›´æ–°ï¼ˆæŒ‡æ•°æ¸›è¡° + ç™ºç«å…¥åŠ›ï¼‰
#   2. LTP/LTDã«åŸºã¥ãé‡ã¿å¤‰åŒ– dw ã®è¨ˆç®—
#   3. é‡ã¿ w ã®æ›´æ–°ã¨è¨˜éŒ²
# ==============================================================
for t in range(nt):
    # pre-synaptic trace ã®æ›´æ–°ï¼ˆæŒ‡æ•°æ¸›è¡°ï¼‹ã‚¹ãƒ‘ã‚¤ã‚¯ã«ã‚ˆã‚‹ä¸Šæ˜‡ï¼‰
    x_pre = x_pre * (1 - dt / tau_p) + spike_pre[t]

    # post-synaptic trace ã®æ›´æ–°
    x_post = x_post * (1 - dt / tau_m) + spike_post[t]

    # é‡ã¿å¤‰åŒ–ã®è¨ˆç®—
    # LTPæˆåˆ†ï¼šA_p * x_pre * spike_post
    # LTDæˆåˆ†ï¼šA_m * x_post * spike_pre
    dw = A_p * x_pre * spike_post[t] - A_m * x_post * spike_pre[t]

    # ã‚·ãƒŠãƒ—ã‚¹é‡ã¿ã®æ›´æ–°
    w += dw

    # å„å€¤ã‚’è¨˜éŒ²
    x_pre_arr[t] = x_pre
    x_post_arr[t] = x_post
    w_arr[t] = w

# ==============================================================
# å¯è¦–åŒ–
# --------------------------------------------------------------
# ä¸Šã‹ã‚‰é †ã«ï¼š
#   1. preãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ã®ãƒˆãƒ¬ãƒ¼ã‚¹
#   2. preãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ã®ã‚¹ãƒ‘ã‚¤ã‚¯åˆ—
#   3. postãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ã®ã‚¹ãƒ‘ã‚¤ã‚¯åˆ—
#   4. postãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ã®ãƒˆãƒ¬ãƒ¼ã‚¹
#   5. ã‚·ãƒŠãƒ—ã‚¹é‡ã¿ã®æ¨ç§»
# ==============================================================
time = np.arange(nt) * dt * 1e3  # æ™‚é–“è»¸ï¼ˆmså˜ä½ï¼‰


def hide_ticks():
    """ä¸Šã¨å³ã®è»¸ã‚’éè¡¨ç¤ºã«ã™ã‚‹è£œåŠ©é–¢æ•°"""
    plt.gca().spines["right"].set_visible(False)
    plt.gca().spines["top"].set_visible(False)
    plt.gca().yaxis.set_ticks_position("left")
    plt.gca().xaxis.set_ticks_position("bottom")


plt.figure(figsize=(6, 6))

# preãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ã®ãƒˆãƒ¬ãƒ¼ã‚¹
plt.subplot(5, 1, 1)
plt.plot(time, x_pre_arr, color="k")
plt.ylabel("$x_{pre}$")
hide_ticks()
plt.xticks([])

# preãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ã®ã‚¹ãƒ‘ã‚¤ã‚¯ç³»åˆ—
plt.subplot(5, 1, 2)
plt.plot(time, spike_pre, color="k")
plt.ylabel("pre-spikes")
hide_ticks()
plt.xticks([])

# postãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ã®ã‚¹ãƒ‘ã‚¤ã‚¯ç³»åˆ—
plt.subplot(5, 1, 3)
plt.plot(time, spike_post, color="k")
plt.ylabel("post-spikes")
hide_ticks()
plt.xticks([])

# postãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ã®ãƒˆãƒ¬ãƒ¼ã‚¹
plt.subplot(5, 1, 4)
plt.plot(time, x_post_arr, color="k")
plt.ylabel("$x_{post}$")
hide_ticks()
plt.xticks([])

# ã‚·ãƒŠãƒ—ã‚¹é‡ã¿ã®å¤‰åŒ–
plt.subplot(5, 1, 5)
plt.plot(time, w_arr, color="k")
plt.xlabel("$t$ (ms)")
plt.ylabel("Synaptic weight $w$")
hide_ticks()
plt.tight_layout()
plt.savefig("online_stdp.pdf")

# ==============================================================
# ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ
# --------------------------------------------------------------
# - preãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ã®ã‚¹ãƒ‘ã‚¤ã‚¯å¾Œã€x_preãŒæ€¥ä¸Šæ˜‡ã—æŒ‡æ•°çš„ã«æ¸›è¡°ã™ã‚‹ã€‚
# - postãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ã®ã‚¹ãƒ‘ã‚¤ã‚¯æ™‚ã«ã€preå´ã®ãƒˆãƒ¬ãƒ¼ã‚¹ãŒå¤§ãã‘ã‚Œã°LTPï¼ˆé‡ã¿ä¸Šæ˜‡ï¼‰ã€
#   é€†ã«postå´ãƒˆãƒ¬ãƒ¼ã‚¹ãŒå¤§ãã‘ã‚Œã°LTDï¼ˆé‡ã¿æ¸›å°‘ï¼‰ãŒç”Ÿã˜ã‚‹ã€‚
# - ã“ã®çµæœã€ã‚¹ãƒ‘ã‚¤ã‚¯ã®é †åºã«åŸºã¥ãå› æœé–¢ä¿‚ãŒã‚·ãƒŠãƒ—ã‚¹å¼·åº¦ã¨ã—ã¦å­¦ç¿’ã•ã‚Œã‚‹ã€‚
# ==============================================================

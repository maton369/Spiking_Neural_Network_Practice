# -*- coding: utf-8 -*-
# ==============================================================
# é…å»¶çµåˆã‚’ä»‹ã—ãŸ2ãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ç³»ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
# --------------------------------------------------------------
# ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã¯ã€2ã¤ã®LIFï¼ˆLeaky Integrate-and-Fireï¼‰ãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³é–“ã«
# ã‚·ãƒŠãƒ—ã‚¹ä¼é”é…å»¶ï¼ˆDelayConnectionï¼‰ã‚’å°å…¥ã—ãŸãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ã€‚
#
# Neuron1 â†’ï¼ˆé…å»¶æ¥ç¶šï¼‰â†’ Neuron2
#
# Neuron1ã¯é€Ÿã„æ™‚å®šæ•°ï¼ˆåå¿œãŒæ—©ã„ï¼‰ã€
# Neuron2ã¯é…ã„æ™‚å®šæ•°ï¼ˆåå¿œãŒéˆã„ï¼‰ã‚’æŒã¡ã€
# ã‚·ãƒŠãƒ—ã‚¹é…å»¶ã«ã‚ˆã‚‹é›»ä½ä¼æ’­ã®æ™‚é–“å·®ã‚’å¯è¦–åŒ–ã§ãã‚‹ã€‚
# ==============================================================

import numpy as np
import matplotlib.pyplot as plt
from tqdm import tqdm

# åŒä¸€éšå±¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from Neurons import CurrentBasedLIF
from Connections import DelayConnection

# ==============================================================
# ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
# --------------------------------------------------------------
# dt : æ™‚é–“åˆ»ã¿å¹… [s]
# T  : ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ [s]
# nt : ã‚¹ãƒ†ãƒƒãƒ—æ•°
# ==============================================================
dt = 1e-4
T = 5e-2
nt = round(T / dt)

# ==============================================================
# ãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ãŠã‚ˆã³é…å»¶æ¥ç¶šã®å®šç¾©
# --------------------------------------------------------------
# neuron1 : å…¥åŠ›é›»æµIã‚’ç›´æ¥å—ã‘ã‚‹é€Ÿã„ãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³
# neuron2 : é…å»¶ã‚’ä»‹ã—ã¦Neuron1ã®å‡ºåŠ›ã‚’å—ã‘ã‚‹é…ã„ãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³
# delay_connect : ã‚·ãƒŠãƒ—ã‚¹é…å»¶ãƒ¢ãƒ‡ãƒ«ï¼ˆ2msï¼‰
# ==============================================================
neuron1 = CurrentBasedLIF(
    N=1, dt=dt, tc_m=1e-2, tref=0, vrest=0, vreset=0, vthr=1, vpeak=1
)
neuron2 = CurrentBasedLIF(
    N=1, dt=dt, tc_m=1e-1, tref=0, vrest=0, vreset=0, vthr=1, vpeak=1
)
delay_connect = DelayConnection(N=1, delay=2e-3, dt=dt)  # 2msé…å»¶

# ==============================================================
# å…¥åŠ›é›»æµã¨è¨˜éŒ²ç”¨å¤‰æ•°ã®åˆæœŸåŒ–
# --------------------------------------------------------------
# I : Neuron1ã¸ã®å®šå¸¸å…¥åŠ› [pA]
# v_arr1, v_arr2 : å„ãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ã®è†œé›»ä½ã‚’è¨˜éŒ²ã™ã‚‹é…åˆ—
# ==============================================================
I = 2  # å…¥åŠ›é›»æµ
v_arr1 = np.zeros(nt)
v_arr2 = np.zeros(nt)

# ==============================================================
# ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
# --------------------------------------------------------------
# å„ã‚¿ã‚¤ãƒ ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã«ä»¥ä¸‹ã‚’å®Ÿè¡Œï¼š
#   1. Neuron1ã«é›»æµIã‚’å…¥åŠ› â†’ ç™ºç«ä¿¡å·s1ã‚’å–å¾—
#   2. s1ã‚’é…å»¶æ¥ç¶šDelayConnectionã«é€šã—ã¦d1ã‚’ç”Ÿæˆ
#   3. d1ã‚’Neuron2ã«ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã—ã¦å…¥åŠ›ã—ã€è†œé›»ä½ã‚’æ›´æ–°
# ==============================================================
for t in tqdm(range(nt)):
    s1 = neuron1(I)  # Neuron1 ã®ç™ºç«å‡ºåŠ›
    d1 = delay_connect(s1)  # ç™ºç«ä¿¡å·ã«é…å»¶ã‚’é©ç”¨
    s2 = neuron2(0.02 / dt * d1)  # Neuron2 ã«é…å»¶å¾Œã®ä¿¡å·ã‚’å…¥åŠ›

    # å„ãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ã®è†œé›»ä½ã‚’ä¿å­˜
    v_arr1[t] = neuron1.v_
    v_arr2[t] = neuron2.v_

# ==============================================================
# å¯è¦–åŒ–
# --------------------------------------------------------------
# Neuron1ã¨Neuron2ã®è†œé›»ä½ã‚’æ™‚é–“è»¸ä¸Šã§æ¯”è¼ƒã€‚
# é…å»¶çµåˆã«ã‚ˆã‚‹åå¿œã®æ™‚é–“å·®ã‚’ç¢ºèªã§ãã‚‹ã€‚
# ==============================================================
time = np.arange(nt) * dt * 1e3  # [ms] å˜ä½ã«å¤‰æ›
plt.figure(figsize=(5, 4))
plt.plot(time, v_arr1, label="Neuron1", color="k", linestyle="dashed")
plt.plot(time, v_arr2, color="k", label="Neuron2")
plt.xlabel("Time (ms)")
plt.ylabel("Membrane potential (v)")
plt.legend(loc="upper left")
plt.tight_layout()
plt.savefig("delay.pdf")
plt.show()

# ==============================================================
# ğŸ” ã‚³ãƒ¡ãƒ³ãƒˆï¼š
# --------------------------------------------------------------
# - Neuron1 ã¯é€Ÿã„è†œæ™‚å®šæ•°ï¼ˆ10 msï¼‰ã‚’æŒã¡ã€å³åº§ã«åå¿œã€‚
# - Neuron2 ã¯è†œæ™‚å®šæ•°ãŒé•·ãï¼ˆ100 msï¼‰ã€åå¿œãŒé…ã„ã€‚
# - 2 ms ã®é…å»¶ã‚’æŒã¤ DelayConnection ã«ã‚ˆã‚Šã€
#   Neuron2 ã®é›»ä½ä¸Šæ˜‡ãŒ Neuron1 ã‚ˆã‚Šé…ã‚Œã¦å‡ºç¾ã€‚
# - ã“ã®çµæœã€ã‚·ãƒŠãƒ—ã‚¹é…å»¶ã®å½±éŸ¿ãŒæ™‚é–“æ³¢å½¢ã¨ã—ã¦å¯è¦–åŒ–ã§ãã‚‹ã€‚
# ==============================================================
